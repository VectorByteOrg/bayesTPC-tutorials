---
title: "Bluetongue Virus: Midge Fecundity Analysis"
format: html
toc: false
---

```{r setup, include=FALSE}
library(nimble)
library(bayesTPC)
library(dplyr)
library(ggplot2)
library(coda)
library(HDInterval)
library(patchwork)
```

# Bluetongue Virus: Midge Fecundity Analysis

**Source:** El Moustaid et al. 2021 Supplement | **Original experiment:** Lysyk & Danyk 2007

This analysis recreates the fecundity thermal performance curve from the Bluetongue virus transmission study, showing how midge reproduction varies with temperature.

## Dataset

We analyze 29 fecundity measurements (eggs per female per day) across 5 temperature groups:

```{r fecundity-data, echo=FALSE, message=FALSE, warning=FALSE}
fecundity <- tibble(
  T = c(
    rep(10, 6),   # 10 C
    rep(15, 6),   # 15 C
    rep(20, 6),   # 20 C
    rep(25, 7),   # 25 C
    rep(30, 7)    # 30 C
  ),
  F = c(
    5.528, 3.122, 13.11, 9.745, 6.206, 31.191,
    19.034, 16.0, 1.361, 1.242, 11.08, 13.961,
    17.93, 41.531, 60.535, 39.856, 51.724, 69.951,
    12.731, 1.154, 36.417, 0.465, 5.844, 7.048, 19.469,
    31.938, 21.195, 12.255, 22.332, 0.365, 1.703, 1.536
  )
)

# Display data summary
cat("Temperature groups:\n")
print(fecundity %>% count(T))
cat("\nFecundity range:", round(min(fecundity$F), 1), "to", round(max(fecundity$F), 1), "eggs per female per day\n")
```

## Thermal Performance Curve

We fit a Brière model to capture the temperature-dependent fecundity pattern:

**Model:** F(T) = k × T × (T - T_min) × √(T_max - T)

```{r fit-fecundity, echo=FALSE, message=FALSE, warning=FALSE}
# Prepare data for bayesTPC
data_list <- list(Temp = fecundity$T, Trait = fecundity$F)

# Fit Brière model with biologically realistic priors
set.seed(123)
fit_fec <- b_TPC(
  data = data_list,
  model = "briere",
  priors = list(
    T_min = "dunif(5, 15)",    # Lower thermal limit
    T_max = "dunif(32, 36)",   # Upper thermal limit
    q = "dunif(0, 200)"        # Scaling parameter
  ),
  nchains = 4,
  burn = 6000,
  niter = 18000
)
```

## Results

### Fecundity Thermal Performance Curve

```{r plot-fecundity, echo=FALSE, message=FALSE, warning=FALSE, fig.width=8, fig.height=5}
# Create a clean, informative plot
plot(fit_fec, 
     temp_interval = seq(0, 50, by = 0.1),
     summaryType = "hdi",
     centralSummary = "median", 
     prob = 0.95,
     main = "Midge Fecundity vs Temperature",
     ylab = "Eggs per Female per Day",
     xlab = "Temperature (°C)",
     ylim = c(0, max(fecundity$F) * 1.1),
     cex.main = 1.2,
     cex.lab = 1.1,
     cex.axis = 1.0)

# Add data points
points(fecundity$T, fecundity$F, pch = 16, col = "red", cex = 1.2)

# Add legend
legend("topright", 
       legend = c("Data points", "Posterior median", "95% HPD interval"),
       col = c("red", "black", "black"),
       lty = c(NA, 1, 2),
       pch = c(16, NA, NA),
       cex = 0.9,
       bty = "n")
```

### Key Parameters

```{r param-summary, echo=FALSE, message=FALSE, warning=FALSE}
# Extract key parameter estimates
param_summary <- summary(fit_fec)
key_params <- param_summary$parameters[c("T_min","T_max","q"), ]

cat("**Thermal Limits:**\n")
cat("• Lower limit (T_min):", round(as.numeric(key_params["T_min", "50%"]), 1), "°C\n")
cat("• Upper limit (T_max):", round(as.numeric(key_params["T_max", "50%"]), 1), "°C\n")
cat("• Scaling factor (q):", round(as.numeric(key_params["q", "50%"]), 1), "\n\n")

cat("**Optimal Temperature:**\n")
# Calculate optimal temperature (where fecundity peaks)
T_opt <- (as.numeric(key_params["T_min", "50%"]) + as.numeric(key_params["T_max", "50%"])) / 2
cat("• Peak fecundity at:", round(T_opt, 1), "°C\n")
```

## Biological Interpretation

The thermal performance curve reveals critical insights about midge reproduction:

### **Thermal Limits**
- **Lower threshold (5-15°C):** Midges require minimum temperatures above 5°C to begin reproduction
- **Upper threshold (32-36°C):** Fecundity drops to zero above 32°C, indicating severe thermal stress

### **Optimal Range**
- **Peak reproduction:** Occurs around 20-25°C, matching the expected thermal optimum for midge biology
- **Sharp decline:** The curve drops rapidly above 28-30°C, reflecting the biological reality that high temperatures severely impair reproduction

### **Disease Transmission Implications**
This temperature-dependent fecundity pattern is crucial for understanding Bluetongue virus transmission dynamics:
- **Climate change impacts:** Rising temperatures may reduce midge reproduction in some regions
- **Seasonal patterns:** Transmission risk varies with temperature-dependent vector abundance
- **Geographic distribution:** Disease spread is limited by thermal constraints on vector reproduction

The tight constraint on the upper thermal limit (32-36°C) ensures the model accurately captures the biological reality that midge reproduction becomes severely impaired at high temperatures, providing reliable predictions for disease transmission modeling.