<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Advanced topics with bayesTPC – bayesTPC Tutorials</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-f59ae89ec823d45c17daa5ec8f2c755b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script type="module" src="site_libs/quarto-ojs/quarto-ojs-runtime.js"></script>
<link href="site_libs/quarto-ojs/quarto-ojs.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="./index.html" class="navbar-brand navbar-brand-logo">
    <img src="./images/vblogoedit.png" alt="" class="navbar-logo">
    </a>
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">bayesTPC Tutorials</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About bayesTPC</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./startup.html"> 
<span class="menu-text">Getting Started</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./intro.html"> 
<span class="menu-text">Tutorials</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./BT_temp.html"> 
<span class="menu-text">Bluetongue Refit</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./team.html"> 
<span class="menu-text">Team</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/VectorByteOrg/bayesTPC-tutorials"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/vectorbite_rcn"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#thermal-performance-curves-under-antibiotics" id="toc-thermal-performance-curves-under-antibiotics" class="nav-link active" data-scroll-target="#thermal-performance-curves-under-antibiotics">Thermal performance curves under antibiotics</a></li>
  <li><a href="#a-flexible-and-interpretable-model-for-thermal-performance-curves" id="toc-a-flexible-and-interpretable-model-for-thermal-performance-curves" class="nav-link" data-scroll-target="#a-flexible-and-interpretable-model-for-thermal-performance-curves">A flexible and interpretable model for thermal performance curves</a></li>
  <li><a href="#adding-the-flextpc-function-to-bayestpc" id="toc-adding-the-flextpc-function-to-bayestpc" class="nav-link" data-scroll-target="#adding-the-flextpc-function-to-bayestpc">Adding the flexTPC function to bayesTPC</a>
  <ul class="collapse">
  <li><a href="#writing-down-an-expression-for-the-flextpc-functional-form" id="toc-writing-down-an-expression-for-the-flextpc-functional-form" class="nav-link" data-scroll-target="#writing-down-an-expression-for-the-flextpc-functional-form">Writing down an expression for the flexTPC functional form</a></li>
  <li><a href="#defining-prior-distributions" id="toc-defining-prior-distributions" class="nav-link" data-scroll-target="#defining-prior-distributions">Defining prior distributions</a></li>
  </ul></li>
  <li><a href="#fitting-the-flextpc-model-to-antibiotic-data" id="toc-fitting-the-flextpc-model-to-antibiotic-data" class="nav-link" data-scroll-target="#fitting-the-flextpc-model-to-antibiotic-data">Fitting the flexTPC model to antibiotic data</a></li>
  <li><a href="#transformations-of-model-parameters" id="toc-transformations-of-model-parameters" class="nav-link" data-scroll-target="#transformations-of-model-parameters">Transformations of model parameters</a></li>
  <li><a href="#posterior-distribution-of-functions-of-model-parameters" id="toc-posterior-distribution-of-functions-of-model-parameters" class="nav-link" data-scroll-target="#posterior-distribution-of-functions-of-model-parameters">Posterior distribution of functions of model parameters</a>
  <ul class="collapse">
  <li><a href="#posterior-distribution-for-the-optimal-temperature" id="toc-posterior-distribution-for-the-optimal-temperature" class="nav-link" data-scroll-target="#posterior-distribution-for-the-optimal-temperature">Posterior distribution for the optimal temperature</a></li>
  </ul></li>
  <li><a href="#posterior-distribution-of-tpc-values-at-specific-temperatures" id="toc-posterior-distribution-of-tpc-values-at-specific-temperatures" class="nav-link" data-scroll-target="#posterior-distribution-of-tpc-values-at-specific-temperatures">Posterior distribution of TPC values at specific temperatures</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model comparison</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content column-page-left" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Advanced topics with bayesTPC</h1>
</div>



<div class="quarto-title-meta column-page-left">

    
  
    
  </div>
  


</header>


<p>In this practical, we will see how to add a custom functional form for thermal performance curves that is not currently implemented in bayesTPC. We will also see how to process the output from bayesTPC to generate custom plots or get the posterior distribution of model parameters.</p>
<p>We’ll start by loading some packages we will need for this section (please make sure you install any that are missing, especially the <code>scales</code> and <code>tidyverse</code> packages, which we’ll need for some custom plots below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment lines below and run to install packages if missing. </span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("tidyverse")</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># install.packages("scales")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(nimble)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(HDInterval)</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MCMCvis)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(coda) <span class="co"># makes diagnostic plots</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(IDPmisc) <span class="co"># makes nice colored pairs plots to look at joint posteriors</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(matrixStats)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(truncnorm)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(bayesTPC)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(scales)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="thermal-performance-curves-under-antibiotics" class="level2">
<h2 class="anchored" data-anchor-id="thermal-performance-curves-under-antibiotics">Thermal performance curves under antibiotics</h2>
<p>Let’s take a look at a <a href="ab_data.csv">dataset</a> of the temperature-dependence of the growth of the bacterium <em>Escherichia coli</em> in the presence of various antibiotic backgrounds (data originally from this <a href="https://journals.asm.org/doi/full/10.1128/msystems.00228-21">study</a>).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>abdata <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(<span class="st">"data/ab_data.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(abdata)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  drug1name drug2name drug1num drug2num  T  t sample          OD
1       ERY       GEN        4        6 37 24      1 0.368300008
2       ERY       GEN        4        6 37 24      2 0.404299991
3       ERY       GEN        4        6 37 24      3 0.423800008
4       ERY       GEN        4        6 37 24      4 0.427200006
5       ERY       GEN        4        6 22 24      1 0.004800001
6       ERY       GEN        4        6 22 24      2 0.005099999</code></pre>
</div>
</div>
<p>This dataset consists of optical density (OD) values (which are proportional to the number of bacteria) of <em>E. coli</em> cultures after 24 hour growth at various temperatures (T) under fixed concentrations of 12 antibiotics and all their pairwise combinations. There are four replicates per drug/temperature treatment.</p>
<p>In this workshop we will focus on comparing how the thermal performance for <em>E. coli</em> growth looks like under four conditions of interest:</p>
<ul>
<li>no antibiotic</li>
<li>gentamicin (GEN)</li>
<li>erythromycin (ERY)</li>
<li>GEN+ERY (both antibiotics present at the same time)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The data uses "WT" to encode "no drug".</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>nodrug <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>GEN <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"GEN"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>ERY <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"ERY"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"WT"</span>))</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>both <span class="ot">&lt;-</span> <span class="fu">subset</span>(abdata, (abdata[<span class="st">"drug1name"</span>] <span class="sc">==</span> <span class="st">"ERY"</span>) <span class="sc">&amp;</span> (abdata[<span class="st">"drug2name"</span>] <span class="sc">==</span> <span class="st">"GEN"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s start by plotting the data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nodrug<span class="sc">$</span>T, nodrug<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(GEN<span class="sc">$</span>T, GEN<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ERY<span class="sc">$</span>T, ERY<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(both<span class="sc">$</span>T, both<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN+ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As might be expected, adding antibiotics to the growth media decreases the number of bacteria. However, they can decrease growth more at some temperatures than others, leading to changes in the shape of the TPC.</p>
<p>Some of the shapes you get when adding antibiotics do not look like typical TPCs and it could be difficult to fit this data with many common TPC models. In the following section, we show how we can add a new functional form to bayesTPC that can describe these TPCs.</p>
</section>
<section id="a-flexible-and-interpretable-model-for-thermal-performance-curves" class="level2">
<h2 class="anchored" data-anchor-id="a-flexible-and-interpretable-model-for-thermal-performance-curves">A flexible and interpretable model for thermal performance curves</h2>
<p>In this section, we introduce a new functional form for thermal performance curves called flexTPC. This model aims to be both flexible (aiming to describe unimodal curves of any skewness) and interpretable (with all model parameters having a clear biological interpretation).</p>
<p>A preprint introducing this model and showing its performance in various different datasets will be available soon. In the meantime, here’s a link to the associated <a href="https://github.com/mcruzloya/flexTPC">GitHub</a> (which will link to the preprint once it’s ready).</p>
<p>The equation for the flexTPC model is</p>
<p><span class="math display">\[
r(T) = r_{\max}\left[\left(\frac{T - T_{\min}}{\alpha} \right)^{\alpha} \left(\frac{T_{\max} - T}{1 - \alpha} \right)^{1-\alpha}
\left(\frac{1}{T_{\max} - T_{\min}} \right)
\right]^\frac{\alpha (1 - \alpha)}{\beta^2}
\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(T_{\min}\)</span> is the minimum temperature,</li>
<li><span class="math inline">\(T_{\max}\)</span> the maximum temperature,</li>
<li><span class="math inline">\(r_{\max}\)</span> the maximum trait value/performance of the TPC,</li>
<li><span class="math inline">\(\alpha \in [0,1]\)</span> determines where the optimal temperature <span class="math inline">\(T_{\mathrm{opt}}\)</span> is relative to <span class="math inline">\(T_{\min}\)</span> and <span class="math inline">\(T_{\max}\)</span> through the equation <span class="math display">\[
T_{\mathrm{opt}} = \alpha T_{\max} + (1 - \alpha) T_{\min}
\]</span> (where, for example, <span class="math inline">\(\alpha = 0\)</span> corresponds to <span class="math inline">\(T_{\mathrm{opt}} = T_{\min}\)</span>, <span class="math inline">\(\alpha = 1\)</span> corresponds to <span class="math inline">\(T_{\mathrm{opt}} = T_{\max}\)</span> and <span class="math inline">\(\alpha = 1/2\)</span> corresponds to a symmetric TPC where <span class="math inline">\(T_{\mathrm{opt}} = (T_{\min} + T_{\max}) / 2\)</span>), and</li>
<li><span class="math inline">\(\beta &gt; 0\)</span> determines the breadth of the TPC near its peak.</li>
</ul>
<p>It may be more intuitive to look at how the predicted TPC changes as we modify each of these parameters. You can change each parameter in flexTPC in the visualization below to see how it affects the shape of the curve. As you can see, flexTPC can describe curves of a wide variety of shapes, as long as they are unimodal (that is, have a single peak).</p>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb7" data-startfrom="105" data-source-offset="-0"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 104;"><span id="cb7-105"><a href="#cb7-105" aria-hidden="true" tabindex="-1"></a>viewof T_min <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb7-106"><a href="#cb7-106" aria-hidden="true" tabindex="-1"></a>  [<span class="op">-</span><span class="dv">5</span><span class="op">,</span> <span class="dv">20</span>]<span class="op">,</span> </span>
<span id="cb7-107"><a href="#cb7-107" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.2</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Tmin:"</span>}</span>
<span id="cb7-108"><a href="#cb7-108" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-109"><a href="#cb7-109" aria-hidden="true" tabindex="-1"></a>viewof T_max <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb7-110"><a href="#cb7-110" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">30</span><span class="op">,</span> <span class="dv">50</span>]<span class="op">,</span> </span>
<span id="cb7-111"><a href="#cb7-111" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">35</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.2</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"Tmax:"</span>}</span>
<span id="cb7-112"><a href="#cb7-112" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-113"><a href="#cb7-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-114"><a href="#cb7-114" aria-hidden="true" tabindex="-1"></a>viewof r_max <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb7-115"><a href="#cb7-115" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="fl">1.2</span>]<span class="op">,</span> </span>
<span id="cb7-116"><a href="#cb7-116" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.1</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"rmax:"</span>}</span>
<span id="cb7-117"><a href="#cb7-117" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-118"><a href="#cb7-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-119"><a href="#cb7-119" aria-hidden="true" tabindex="-1"></a>viewof alpha <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb7-120"><a href="#cb7-120" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> </span>
<span id="cb7-121"><a href="#cb7-121" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="fl">0.8</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.02</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"alpha:"</span>}</span>
<span id="cb7-122"><a href="#cb7-122" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb7-123"><a href="#cb7-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-124"><a href="#cb7-124" aria-hidden="true" tabindex="-1"></a>viewof beta <span class="op">=</span> Inputs<span class="op">.</span><span class="fu">range</span>(</span>
<span id="cb7-125"><a href="#cb7-125" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> </span>
<span id="cb7-126"><a href="#cb7-126" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">value</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">step</span><span class="op">:</span> <span class="fl">0.02</span><span class="op">,</span> <span class="dt">label</span><span class="op">:</span> <span class="st">"beta:"</span>}</span>
<span id="cb7-127"><a href="#cb7-127" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-1-5" data-nodetype="declaration">

</div>
</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code hidden" id="cb8" data-startfrom="133" data-source-offset="-1"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript" style="counter-reset: source-line 132;"><span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">incrementalArray</span>(start<span class="op">,</span> end<span class="op">,</span> step) {</span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> arr <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>    <span class="co">// convert count to an integer to avoid rounding errors</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> count <span class="op">=</span> <span class="op">+</span>((end <span class="op">-</span> start) <span class="op">/</span> step)<span class="op">.</span><span class="fu">toFixed</span>()<span class="op">;</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">var</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;=</span> count<span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> i <span class="op">=</span> start <span class="op">+</span> j <span class="op">*</span> step<span class="op">;</span></span>
<span id="cb8-139"><a href="#cb8-139" aria-hidden="true" tabindex="-1"></a>        arr<span class="op">.</span><span class="fu">push</span>(i)<span class="op">;</span></span>
<span id="cb8-140"><a href="#cb8-140" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb8-141"><a href="#cb8-141" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> arr<span class="op">;</span></span>
<span id="cb8-142"><a href="#cb8-142" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-143"><a href="#cb8-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-144"><a href="#cb8-144" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">flexTPC</span>(x<span class="op">,</span> T_min<span class="op">,</span> T_max<span class="op">,</span> r_max<span class="op">,</span> alpha<span class="op">,</span> beta) {</span>
<span id="cb8-145"><a href="#cb8-145" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="op">&lt;</span> T_min) {</span>
<span id="cb8-146"><a href="#cb8-146" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb8-147"><a href="#cb8-147" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-148"><a href="#cb8-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (x <span class="op">&gt;</span> T_max) {</span>
<span id="cb8-149"><a href="#cb8-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fl">0.0</span></span>
<span id="cb8-150"><a href="#cb8-150" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb8-151"><a href="#cb8-151" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> r_max <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">exp</span>((alpha <span class="op">*</span> (<span class="fl">1.0</span> <span class="op">-</span> alpha) <span class="op">/</span> beta<span class="op">**</span><span class="dv">2</span>) <span class="op">*</span> (alpha <span class="op">*</span>    <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>( (x <span class="op">-</span> T_min) <span class="op">/</span> alpha)  <span class="op">+</span> </span>
<span id="cb8-152"><a href="#cb8-152" aria-hidden="true" tabindex="-1"></a>      (<span class="fl">1.0</span> <span class="op">-</span> alpha) <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>( (T_max <span class="op">-</span> x) <span class="op">/</span> (<span class="fl">1.0</span> <span class="op">-</span> alpha)) <span class="op">-</span></span>
<span id="cb8-153"><a href="#cb8-153" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Math</span><span class="op">.</span><span class="fu">log</span>(T_max <span class="op">-</span> T_min)))</span>
<span id="cb8-154"><a href="#cb8-154" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-155"><a href="#cb8-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-156"><a href="#cb8-156" aria-hidden="true" tabindex="-1"></a>xvals <span class="op">=</span> <span class="fu">incrementalArray</span>(<span class="op">-</span><span class="dv">5</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="fl">0.1</span>)</span>
<span id="cb8-157"><a href="#cb8-157" aria-hidden="true" tabindex="-1"></a>yvals <span class="op">=</span> xvals<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> <span class="fu">flexTPC</span>(x<span class="op">,</span> T_min<span class="op">,</span> T_max<span class="op">,</span> r_max<span class="op">,</span> alpha<span class="op">,</span> beta))</span>
<span id="cb8-158"><a href="#cb8-158" aria-hidden="true" tabindex="-1"></a>zip <span class="op">=</span> (a<span class="op">,</span> b) <span class="kw">=&gt;</span> a<span class="op">.</span><span class="fu">map</span>((k<span class="op">,</span> i) <span class="kw">=&gt;</span> [k<span class="op">,</span> b[i]])<span class="op">;</span></span>
<span id="cb8-159"><a href="#cb8-159" aria-hidden="true" tabindex="-1"></a>data <span class="op">=</span> <span class="fu">zip</span>(xvals<span class="op">,</span> yvals)</span>
<span id="cb8-160"><a href="#cb8-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-161"><a href="#cb8-161" aria-hidden="true" tabindex="-1"></a>Plot<span class="op">.</span><span class="fu">plot</span>({</span>
<span id="cb8-162"><a href="#cb8-162" aria-hidden="true" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="dv">600</span><span class="op">,</span></span>
<span id="cb8-163"><a href="#cb8-163" aria-hidden="true" tabindex="-1"></a>  <span class="dt">height</span><span class="op">:</span> <span class="dv">400</span><span class="op">,</span></span>
<span id="cb8-164"><a href="#cb8-164" aria-hidden="true" tabindex="-1"></a>  <span class="dt">y</span><span class="op">:</span> { <span class="dt">domain</span><span class="op">:</span> [<span class="op">-</span><span class="fl">0.01</span><span class="op">,</span> <span class="fl">1.25</span>] }<span class="op">,</span></span>
<span id="cb8-165"><a href="#cb8-165" aria-hidden="true" tabindex="-1"></a>  <span class="dt">marks</span><span class="op">:</span> [</span>
<span id="cb8-166"><a href="#cb8-166" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">line</span>(</span>
<span id="cb8-167"><a href="#cb8-167" aria-hidden="true" tabindex="-1"></a>      data<span class="op">,</span></span>
<span id="cb8-168"><a href="#cb8-168" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb8-169"><a href="#cb8-169" aria-hidden="true" tabindex="-1"></a>        <span class="dt">strokeWidth</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb8-170"><a href="#cb8-170" aria-hidden="true" tabindex="-1"></a>        <span class="dt">stroke</span><span class="op">:</span> <span class="st">"steelblue"</span><span class="op">,</span></span>
<span id="cb8-171"><a href="#cb8-171" aria-hidden="true" tabindex="-1"></a>        <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span></span>
<span id="cb8-172"><a href="#cb8-172" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb8-173"><a href="#cb8-173" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb8-174"><a href="#cb8-174" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">ruleX</span>([<span class="dv">0</span>])<span class="op">,</span></span>
<span id="cb8-175"><a href="#cb8-175" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">ruleY</span>([<span class="dv">0</span>])<span class="op">,</span></span>
<span id="cb8-176"><a href="#cb8-176" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">axisX</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"Temperature [°C]"</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span> <span class="dt">marginBottom</span><span class="op">:</span> <span class="dv">40</span>})<span class="op">,</span></span>
<span id="cb8-177"><a href="#cb8-177" aria-hidden="true" tabindex="-1"></a>    Plot<span class="op">.</span><span class="fu">axisY</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">"trait performance"</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">14</span><span class="op">,</span> <span class="dt">x</span><span class="op">:</span> <span class="dv">0</span> })</span>
<span id="cb8-178"><a href="#cb8-178" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb8-179"><a href="#cb8-179" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-1" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-2" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-3" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-4" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-5" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-6" data-nodetype="declaration">

</div>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<div id="ojs-cell-2-7" data-nodetype="expression">

</div>
</div>
</div>
</div>
</section>
<section id="adding-the-flextpc-function-to-bayestpc" class="level2">
<h2 class="anchored" data-anchor-id="adding-the-flextpc-function-to-bayestpc">Adding the flexTPC function to bayesTPC</h2>
<p>We want to add the flexTPC functional form to bayesTPC in order to fit this data. To do this, we need to do the following:</p>
<ul>
<li><p>We need to write down the flexTPC equation in a format that is understood by bayesTPC.</p></li>
<li><p>We need to set default prior distributions for all parameters in the model. As we will be focusing on the antibiotic dataset presented earlier, we will define the priors we want to use in this case here directly rather than defining default non-restrictive priors.</p></li>
</ul>
<section id="writing-down-an-expression-for-the-flextpc-functional-form" class="level3">
<h3 class="anchored" data-anchor-id="writing-down-an-expression-for-the-flextpc-functional-form">Writing down an expression for the flexTPC functional form</h3>
<p>Every functional form in bayesTPC needs to be written down as an expression in R. Let’s start by writing down an expression for the flexTPC equation. In order to avoid some numerical issues, we’ll actually write it in a slightly different way than shown in the equation above. It is not important to understand how these two forms are related, but here’s an <a href="flexTPC_code_equation.pdf">explanation</a> if you’re curious (you can safely skip this).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Note: This looks a little different from the equation as written above, but is</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="do">## equivalent to it. It's just written a little differently for numerical stability.</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>flexTPC_formula <span class="ot">&lt;-</span> <span class="fu">expression</span>((T_max <span class="sc">&gt;</span> Temp) <span class="sc">*</span> (T_min <span class="sc">&lt;</span> Temp) <span class="sc">*</span> r_max <span class="sc">*</span> <span class="fu">exp</span>((alpha <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span>) <span class="sc">*</span> (alpha <span class="sc">*</span> <span class="fu">log</span>( <span class="fu">max</span>((Temp <span class="sc">-</span> T_min) <span class="sc">/</span> alpha, <span class="dv">10</span><span class="sc">^-</span><span class="dv">20</span>)) </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                                                                                    <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> <span class="fu">log</span>(<span class="fu">max</span> ((T_max <span class="sc">-</span> Temp) <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">-</span> alpha), <span class="dv">10</span><span class="sc">^-</span><span class="dv">20</span>))</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>                                                                                    <span class="sc">-</span> <span class="fu">log</span>(T_max <span class="sc">-</span> T_min)) ) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="defining-prior-distributions" class="level3">
<h3 class="anchored" data-anchor-id="defining-prior-distributions">Defining prior distributions</h3>
<p>We also need to define prior distributions for every parameter in the model. Rather than define default nonrestrictive priors for all parameters, we will define the prior distributions we want to use for the antibiotic data directly.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prior distributions.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>flexTPC_priors <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_max =</span> <span class="st">"dunif(0, 1)"</span>, <span class="co"># Maximum trait value. Chosen because OD values are less than one and because we want to give equal prior probability to all values in the [0, 1] interval.</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">T_max =</span> <span class="st">"dnorm(46, 1 / 2^2)"</span>, <span class="do">## Normal prior with mu=46, sigma=2. Assumes 95% prior CI of approximately [42°C, 50°C].</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">T_min =</span> <span class="st">"dnorm(10, 1 / 5^2)"</span>, <span class="do">## Normal prior with mu=10, sigma=5. Assumes 95% prior CI of approximately [0°C, 20°C]</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">alpha =</span> <span class="st">"dunif(0, 1)"</span>, <span class="do">## Uniform prior in alpha places equal prior probability on T_opt being anywhere in-between T_min and T_max.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">beta =</span> <span class="st">"dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)"</span>) <span class="do">## Gamma prior with mean of 0.3 and standard deviation of 0.2. Asssumes 95% prior CI of approx [0.01, 0.99] for beta. Typical TPCs like those that are described by the Briere and quadratic models have values around 0.2 to 0.4.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we have all the ingredients we need, we can define the flexTPC model in bayesTPC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>flexTPC_normal <span class="ot">&lt;-</span> <span class="fu">specify_normal_model</span>(<span class="st">"flexTPC_normal"</span>, <span class="co">#model name</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">parameters =</span> flexTPC_priors, <span class="co">#names are parameters, values are priors</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">formula =</span> flexTPC_formula</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Model type 'flexTPC_normal' can now be accessed using other bayesTPC functions. Use `reset_models()` to reset back to defaults.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">configure_model</span>(flexTPC_normal))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>{
    for (i in 1:N){
        m[i] &lt;- ( (T_max &gt; Temp[i]) * (T_min &lt; Temp[i]) * r_max * exp((alpha * (1 - alpha)/beta^2) * (alpha * log(max((Temp[i] - T_min)/alpha, 10^-20)) + (1 - alpha) * log(max((T_max - Temp[i])/(1 - alpha), 10^-20)) - log(T_max - T_min))) )
        Trait[i] ~ T(dnorm(mean = m[i], tau = 1/sigma.sq), 0, )
    }
    r_max ~ dunif(0, 1)
    T_max ~ dnorm(46, 1 / 2^2)
    T_min ~ dnorm(10, 1 / 5^2)
    alpha ~ dunif(0, 1)
    beta ~ dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)
    sigma.sq ~ dexp(1)
}</code></pre>
</div>
</div>
<p>For any model defined in bayesTPC, we can take a look at how the model expression and the default priors are defined. Let’s do this for flexTPC.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_formula</span>(<span class="st">"flexTPC_normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>expression((T_max &gt; Temp) * (T_min &lt; Temp) * r_max * exp((alpha * 
    (1 - alpha)/beta^2) * (alpha * log(max((Temp - T_min)/alpha, 
    10^-20)) + (1 - alpha) * log(max((T_max - Temp)/(1 - alpha), 
    10^-20)) - log(T_max - T_min))))</code></pre>
</div>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_default_priors</span>(<span class="st">"flexTPC_normal"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                               r_max                                T_max 
                       "dunif(0, 1)"                 "dnorm(46, 1 / 2^2)" 
                               T_min                                alpha 
                "dnorm(10, 1 / 5^2)"                        "dunif(0, 1)" 
                                beta                             sigma.sq 
"dgamma(0.3^2 / 0.2^2, 0.3 / 0.2^2)"                            "dexp(1)" </code></pre>
</div>
</div>
<p>Optional: Try looking at the formula and default priors for another model in bayesTPC such as the Briere model.</p>
</section>
</section>
<section id="fitting-the-flextpc-model-to-antibiotic-data" class="level2">
<h2 class="anchored" data-anchor-id="fitting-the-flextpc-model-to-antibiotic-data">Fitting the flexTPC model to antibiotic data</h2>
<p>Now let’s get the data in the right shape and fit the flexTPC model to the data of our conditions of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>nodrug.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> nodrug<span class="sc">$</span>OD, <span class="at">Temp=</span>nodrug<span class="sc">$</span>T)</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>nodrugFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> nodrug.data.bTPC, <span class="do">## data</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [Note] safeDeparse: truncating deparse output to 1 line</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>GEN.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> GEN<span class="sc">$</span>OD, <span class="at">Temp=</span>GEN<span class="sc">$</span>T)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>GENFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> GEN.data.bTPC, <span class="do">## data</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.5</span>,</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.7</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [Note] safeDeparse: truncating deparse output to 1 line</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ERY.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> ERY<span class="sc">$</span>OD, <span class="at">Temp=</span>ERY<span class="sc">$</span>T)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>ERYFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> ERY.data.bTPC, <span class="do">## data</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [Note] safeDeparse: truncating deparse output to 1 line</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>both.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> both<span class="sc">$</span>OD, <span class="at">Temp=</span>both<span class="sc">$</span>T)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>bothFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> both.data.bTPC, <span class="do">## data</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin =</span> <span class="dv">2</span>,</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">inits =</span> <span class="fu">list</span>(<span class="st">"T_min"</span><span class="ot">=</span><span class="dv">15</span>, <span class="st">"T_max"</span><span class="ot">=</span><span class="dv">46</span>, <span class="st">"alpha"</span><span class="ot">=</span><span class="fl">0.8</span>,</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>                                  <span class="st">"beta"</span><span class="ot">=</span><span class="fl">0.3</span>, <span class="st">"r_max"</span><span class="ot">=</span><span class="fl">0.8</span>)</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [Note] safeDeparse: truncating deparse output to 1 line</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
</div>
<p>Most of the traceplots look OK, but here is an example of one that doesn’t look great:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">2</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">traceplot</span>(ERYFit, <span class="at">burn=</span><span class="dv">10000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-11-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see than not all of our samples look like a “fuzzy caterpillar” (or at least a healthy one). As can be seen in the traceplot for <span class="math inline">\(r_{\max}\)</span>, occasionally the samples seem to get stuck in some regions of the parameter space. This means the MCMC chains may be converging slowly for some parameters.</p>
<p>There’s a few things that can help with convergence of the MCMC chains:</p>
<ul>
<li><p>Try another sampler.</p></li>
<li><p>Try setting the initial values of the parameters to values that are likely to be near the best fitting values.</p></li>
<li><p>Use stronger prior distributions.</p></li>
<li><p>Run the chains for longer.</p></li>
</ul>
<p>There are also some diagnostics based on running multiple chains (ideally started from different initial values) that can help us evaluate convergence based on how similar the samples from the different chains are to each other. Future versions of bayesTPC will include the ability to run multiple chains and some of these diagnostics.</p>
<p>In this tutorial we’re running the chains for 50000 iterations (instead of 10000 as in previous examples) and providing reasonable initial values which improved sampling compared to initial experiments with shorter runs. For final results, we’d probably run the chains even longer to be safe, although it wouldn’t be practical to do this here due to time constraints.</p>
<p>However, most of the parameters show good mixing and the TPCs we get look reasonable when plotted with the data (you can scroll down to the plots a couple sections below). So it’s likely OK to use our samples for the analysis.</p>
</section>
<section id="transformations-of-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="transformations-of-model-parameters">Transformations of model parameters</h2>
<p>Before proceeding with the analysis, we should probably plot the curves along with the data. However, we will do this a little bit later in this practical, since we want to show how to do this directly from the MCMC samples to see how we can customize our plots.</p>
<p>When using MCMC methods, we obtain samples from the posterior distribution of the parameters in our model from our MCMC chain. For example, let’s take a look at the first few samples from the condition with no antibiotics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(nodrugFit<span class="sc">$</span>samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Markov Chain Monte Carlo (MCMC) output:
Start = 1 
End = 7 
Thinning interval = 1 
        T_max    T_min     alpha      beta     r_max     sigma.sq
[1,] 44.10018 16.65901 0.8294594 0.3671241 0.7913612 0.0014466237
[2,] 44.05463 17.08606 0.8449004 0.3635676 0.7712699 0.0018935016
[3,] 44.10128 17.68970 0.8109676 0.3974284 0.7873828 0.0018976245
[4,] 44.11451 17.72193 0.8145201 0.3705644 0.8236235 0.0019121465
[5,] 44.07358 18.64857 0.8143284 0.3888070 0.8120611 0.0025006970
[6,] 44.05575 18.21946 0.8370196 0.3896825 0.7752230 0.0020226051
[7,] 44.02665 19.19668 0.8348606 0.4121252 0.7715732 0.0008952394</code></pre>
</div>
</div>
<p>Each row corresponds to the values of the parameters in one iteration of the chain. Once the MCMC chain has reached convergence, each iteration corresponds to drawing a sample from the posterior distribution.</p>
<p>We can plot the posterior distribution for the individual parameters using these samples. For example, we may want to compare the height of the TPCs (which corresponds to parameter <span class="math inline">\(r_{\max}\)</span>) between the different antibiotic backgrounds. In this data, this would correspond to the maximum optical density (which is proportional to number of bacteria) under the corresponding antibiotic condition at any temperature.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY+GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Now that we know how to extract posterior samples for our model parameters from the MCMC chains, we will see how we can use these samples to obtain posterior samples for other quantities.</p>
</section>
<section id="posterior-distribution-of-functions-of-model-parameters" class="level2">
<h2 class="anchored" data-anchor-id="posterior-distribution-of-functions-of-model-parameters">Posterior distribution of functions of model parameters</h2>
<p>We can also use the MCMC samples to obtain the posterior distribution (and summaries like medians and credible intervals) of any function involving the model parameters. For example, we might be interested in the difference between the maximum growth observed under the conditions with antibiotics present and when there are no antibiotics in the growth media (note: to do this we need to have the same number of samples for all chains we are comparing).</p>
<p>We can do this by simply subtracting the <span class="math inline">\(r_{\max}\)</span> samples for the conditions of interest (antibiotic(s) and no antibiotic). This will give us a sample of the posterior distribution of the difference between these conditions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>, <span class="dv">2</span>))</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>( bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="at">main=</span><span class="st">"ERY+GEN"</span>, <span class="at">xlab=</span><span class="st">"r_max difference"</span>, <span class="at">xlim=</span><span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>As before, we can calculate medians and credible intervals for these differences.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"ERY"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ERY"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(ERYFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%        50%      97.5% 
-0.3191889 -0.1518516  0.1622027 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"GEN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "GEN"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(GENFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      2.5%        50%      97.5% 
-0.4947349 -0.4454655 -0.3997772 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">"ERY+GEN"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "ERY+GEN"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(bothFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>] <span class="sc">-</span> nodrugFit<span class="sc">$</span>samples[, <span class="st">"r_max"</span>], <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       2.5%         50%       97.5% 
-0.35542608 -0.27921821 -0.05925456 </code></pre>
</div>
</div>
<p>Optional exercise: Maybe we are interested in the proportion of maximum growth in the presence of antibiotics relative to no antibiotics (i.e.&nbsp;the quotient of <span class="math inline">\(r_\max\)</span> values rather than the difference). Could you modify the code to calculate this instead?</p>
<section id="posterior-distribution-for-the-optimal-temperature" class="level3">
<h3 class="anchored" data-anchor-id="posterior-distribution-for-the-optimal-temperature">Posterior distribution for the optimal temperature</h3>
<p>Let’s try another example. In the flexTPC model we have an explicit equation for the optimal temperature</p>
<p><span class="math display">\[ T_{\mathrm{opt}} = \alpha T_{\max} + (1 - \alpha) T_{\min} \]</span></p>
<p>Using this equation, we can also get posterior samples for <span class="math inline">\(T_{\mathrm{opt}}\)</span> by transforming the posterior samples for <span class="math inline">\(T_{\min}\)</span>, <span class="math inline">\(T_{\max}\)</span> and <span class="math inline">\(\alpha\)</span>. For example, for the no-antibiotics condition,</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate Topt in flexTPC model from Tmin, Tmax and alpha.</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>T_opt_fn <span class="ot">&lt;-</span> <span class="cf">function</span>(Tmin, Tmax, alpha) {</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(alpha <span class="sc">*</span> Tmax <span class="sc">+</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> Tmin)</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">1</span>))</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>T_opt_samples <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">T_opt_fn</span>(x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]], x[[<span class="st">'alpha'</span>]]))</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="fu">hist</span>(T_opt_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-16-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can then obtain summaries of the posterior distribution of <span class="math inline">\(T_{\mathrm{opt}}\)</span> such as the mean, median and/or credible intervals.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(T_opt_samples)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 39.11627</code></pre>
</div>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">quantile</span>(T_opt_samples, <span class="fu">c</span>(<span class="fl">0.025</span>, <span class="fl">0.5</span>, <span class="fl">0.975</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    2.5%      50%    97.5% 
37.81725 39.10823 40.41961 </code></pre>
</div>
</div>
<p>(Optional exercise: Try calculating the posterior distribution for the optimal temperature of the TPC for a different condition where antibiotics are present.)</p>
</section>
</section>
<section id="posterior-distribution-of-tpc-values-at-specific-temperatures" class="level2">
<h2 class="anchored" data-anchor-id="posterior-distribution-of-tpc-values-at-specific-temperatures">Posterior distribution of TPC values at specific temperatures</h2>
<p>We can follow a similar approach to obtain the posterior distribution of the value of the thermal performance curve at any temperature (or a grid of temperatures). In this case, the transformation of the parameters we want is simply the equation for the flexTPC model itself at the temperature(s) of interest.</p>
<p>By calculating the predicted value at a certain temperature for the parameters that are drawn in each row of our MCMC chains we can get samples from the posterior distribution of the curve at that temperature. We can then directly calculate medians and credible intervals to plot the TPCs.</p>
<p>It can be useful to calculate these values directly if we want to customize our plots to make them nicer compared to the bayesTPC defaults. Let’s first look at how we can get these posterior samples for a grid of temperatures.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Grid of temperatures to use to plot the TPCs.</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">11</span>, <span class="dv">49</span>, <span class="fl">0.1</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="co"># FlexTPC equation. This is equivalent to the equation shown above, although it's written a little differently.</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>flexTPC <span class="ot">&lt;-</span> <span class="cf">function</span>(T, Tmin, Tmax, rmax, alpha, beta) {</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>  Tidx <span class="ot">&lt;-</span> (T <span class="sc">&gt;</span> Tmin) <span class="sc">&amp;</span> (T <span class="sc">&lt;</span> Tmax)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>  result <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, <span class="fu">length</span>(T))</span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a>  result[Tidx] <span class="ot">&lt;-</span> rmax <span class="sc">*</span> <span class="fu">exp</span>(alpha <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">/</span> beta<span class="sc">^</span><span class="dv">2</span> <span class="sc">*</span>(alpha <span class="sc">*</span> <span class="fu">log</span>((T[Tidx] <span class="sc">-</span> Tmin) <span class="sc">/</span> alpha ) <span class="sc">+</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>                             (<span class="dv">1</span> <span class="sc">-</span> alpha) <span class="sc">*</span> <span class="fu">log</span>((Tmax <span class="sc">-</span> T[Tidx]) <span class="sc">/</span> ( <span class="dv">1</span> <span class="sc">-</span> alpha) )</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>                           <span class="sc">-</span> <span class="fu">log</span>(Tmax <span class="sc">-</span> Tmin)))</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(result)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="do">## Here we apply the flexTPC equation to the parameter values at each iteration of the MCMC chain,</span></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="do">## evaluated at each temperature in our grid.</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>ndcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a>GENcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(GENFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>ERYcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(ERYFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>bothcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(bothFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have a posterior sample for the TPC y-axis value at each of the (x-axis) temperature values in our grid. To clarify this, let’s plot a few of these samples.</p>
<p>(Note: Please make sure you have the <code>scales</code> package, as we’ll need it in order to make partially transparent colors for some of the plots below).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nodrug<span class="sc">$</span>T, nodrug<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="do">## We're plotting the curves that correspond to the first 20 samples in the chain (after removing the burnin samples).</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">20</span>) {</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(temp, ndcurves[ , i], <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">'black'</span>, <span class="fl">0.2</span>))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Each curve we’re plotting corresponds to the flexTPC model when the parameters are fixed at the current iteration of the MCMC chain. With Bayesian methods, rather than fitting a single curve we have a posterior distribution of possible curves that are consistent with the data and priors.</p>
<p>Now we can plot the medians (or means) and 95% credible interval at each temperature value in our grid for all antibiotic conditions.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(nodrug<span class="sc">$</span>T, nodrug<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"No drug"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>) <span class="co"># Plot median of curves at each temperature in grid.</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>) <span class="co"># Plot shaded region with 95% credible interval.</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(GEN<span class="sc">$</span>T, GEN<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'steelblue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"steelblue"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(ERY<span class="sc">$</span>T, ERY<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'darkgreen'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"darkgreen"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(both<span class="sc">$</span>T, both<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"GEN+ERY"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"purple"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Having the posterior samples of the TPCs allows us more flexibility in how we display the data when compared to the default plots on bayesTPC. For example, we can plot all the fitted TPCs together to more easily compare them.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">10</span>, <span class="dv">50</span>, <span class="fl">0.1</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="st">""</span>, <span class="st">""</span>, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"All TPCs"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>ndcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(nodrugFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ndcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>GENcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(GENFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'steelblue'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(GENcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb60-16"><a href="#cb60-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"steelblue"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb60-17"><a href="#cb60-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" aria-hidden="true" tabindex="-1"></a>ERYcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(ERYFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb60-19"><a href="#cb60-19" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb60-20"><a href="#cb60-20" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'darkgreen'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb60-21"><a href="#cb60-21" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb60-22"><a href="#cb60-22" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(ERYcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb60-23"><a href="#cb60-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"darkgreen"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span>
<span id="cb60-24"><a href="#cb60-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-25"><a href="#cb60-25" aria-hidden="true" tabindex="-1"></a>bothcurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(bothFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb60-26"><a href="#cb60-26" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb60-27"><a href="#cb60-27" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'purple'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb60-28"><a href="#cb60-28" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb60-29"><a href="#cb60-29" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(bothcurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb60-30"><a href="#cb60-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"purple"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Here, the curve with no antibiotics is shown in black. We can see that the GEN+ERY (purple) curve looks very similar to the curve with only ERY (green). In both cases, the number of bacteria is reduced more sharply at low temperatures. The TPC for GEN (blue) looks very different, reducing the number of bacteria more sharply at high temperatures.</p>
<p>Note that we could use the same functional form (the flexTPC equation) for all of these conditions despite their different shapes. Using a flexible model allows us to directly compare the inferred parameters of thermal performance curves that vary in shape like in this example.</p>
</section>
<section id="model-comparison" class="level2">
<h2 class="anchored" data-anchor-id="model-comparison">Model comparison</h2>
<p>In this section, we show another example where we compare between different models with bayesTPC using WAIC. We will compare two candidate models for our data:</p>
<p>a) A single TPC model for the data of all of the antibiotic conditions. This corresponds to a null hypothesis that antibiotics do not affect the thermal performance curve (or equivalently, that all the data comes from the same curve).</p>
<p>b) Separate TPC models for each antibiotic background, as we had before.</p>
<p>Let’s fit the model that treats all data as coming from the same thermal performance curve.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Make a single dataset with the data for all antibiotic backgrounds.</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>allconds <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(nodrug, GEN, ERY, both)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a flexTPC model to this data.</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>allconds.data.bTPC<span class="ot">&lt;-</span><span class="fu">list</span>(<span class="at">Trait =</span> allconds<span class="sc">$</span>OD, <span class="at">Temp=</span>allconds<span class="sc">$</span>T)</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>allcondsFit <span class="ot">&lt;-</span> <span class="fu">b_TPC</span>(<span class="at">data =</span> allconds.data.bTPC, <span class="do">## data</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>                     <span class="at">model =</span> <span class="st">'flexTPC_normal'</span>, <span class="do">## model to fit</span></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>                     <span class="at">niter =</span> <span class="dv">50000</span>, <span class="do">## total iterations</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>                     <span class="at">burn =</span> <span class="dv">10000</span>, <span class="do">## number of burn in samples</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>                     <span class="at">samplerType =</span> <span class="st">'AF_slice'</span>, <span class="do">## slice sampler</span></span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a>                     <span class="at">priors =</span> <span class="fu">list</span>(<span class="at">sigma.sq =</span> <span class="st">'dexp(1 / 0.1^2)'</span>), <span class="do">## priors</span></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a>                     <span class="at">thin=</span><span class="dv">2</span></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Creating NIMBLE model:
 - Configuring model.</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>  [Note] safeDeparse: truncating deparse output to 1 line</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code> - Compiling model.

Creating MCMC:
 - Configuring MCMC.
 - Compiling MCMC.
 - Running MCMC.

Progress:
|-------------|-------------|-------------|-------------|
|-------------------------------------------------------|

Configuring Output:
 - Finding Max. a Post. parameters.</code></pre>
</div>
</div>
<p>Now let’s plot the TPC fit of the null-hypothesis model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(allconds<span class="sc">$</span>T, allconds<span class="sc">$</span>OD, <span class="at">xlab=</span><span class="st">"Temperature [°C]"</span>, <span class="at">ylab=</span><span class="st">"OD"</span>, <span class="at">main=</span><span class="st">"All data together"</span>, <span class="at">ylim=</span><span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlim=</span><span class="fu">c</span>(<span class="dv">10</span>, <span class="dv">50</span>))</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>accurves <span class="ot">&lt;-</span> <span class="fu">apply</span>(allcondsFit<span class="sc">$</span>samples, <span class="dv">1</span>, <span class="cf">function</span>(x) <span class="fu">flexTPC</span>(temp, x[[<span class="st">'T_min'</span>]], x[[<span class="st">'T_max'</span>]],</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>                                                          x[[<span class="st">'r_max'</span>]], x[[<span class="st">'alpha'</span>]], x[[<span class="st">'beta'</span>]]))</span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(temp, <span class="fu">apply</span>(accurves, <span class="dv">1</span>, median), <span class="at">col=</span><span class="st">'black'</span>, <span class="at">lwd=</span><span class="dv">2</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(temp, <span class="fu">rev</span>(temp)), <span class="fu">c</span>(<span class="fu">apply</span>(accurves, <span class="dv">1</span>, quantile, <span class="fl">0.025</span>),</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>                                <span class="fu">rev</span>(<span class="fu">apply</span>(accurves, <span class="dv">1</span>, quantile, <span class="fl">0.975</span>))), </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">col=</span><span class="fu">alpha</span>(<span class="st">"black"</span>, <span class="fl">0.3</span>), <span class="at">lty=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="EEID2024_advanced_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can now do model selection through WAIC. First, let’s find the WAIC for the single curve model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(allcondsFit)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>       WAIC        lppd       pWAIC 
-120.208842   65.203846    5.099425 </code></pre>
</div>
</div>
<p>This gives us three values: WAIC (the main quantity we’re interested in), and two terms that are used to calculate the WAIC. These are the lppd (which measures how well the model fits the data) and pWAIC (a term that measures model complexity that depends on the number of parameters and how constrained they are by the priors).</p>
<p>We can access the WAIC value itself with the following code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(allcondsFit)[[<span class="st">"WAIC"</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -120.2088</code></pre>
</div>
</div>
<p>We can now find the WAICs from the individual curves. WAIC is calculated for each individual data point and added to get the final value. Because of this, we can simply add the WAICs for the individual curves to get a value that we can compare to the one we calculated above for the null model.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>nodrugWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(nodrugFit)[[<span class="st">"WAIC"</span>]] </span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>ERYWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(ERYFit)[[<span class="st">"WAIC"</span>]]</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>GENWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(GENFit)[[<span class="st">"WAIC"</span>]]  </span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>bothWAIC <span class="ot">&lt;-</span> bayesTPC<span class="sc">::</span><span class="fu">get_WAIC</span>(bothFit)[[<span class="st">"WAIC"</span>]]</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>nodrugWAIC <span class="sc">+</span> ERYWAIC <span class="sc">+</span> GENWAIC <span class="sc">+</span> bothWAIC</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -395.8602</code></pre>
</div>
</div>
<p>The WAIC for the individual curves is much lower (more negative) than for the single curve describing all data. Based on this, modeling this data as individual TPCs is preferred compared to having a single curve for all conditions.</p>


</section>

</main> <!-- /main -->
<script type="ojs-module-contents">
eyJjb250ZW50cyI6W3sibWV0aG9kTmFtZSI6ImludGVycHJldCIsImNlbGxOYW1lIjoib2pzLWNlbGwtMSIsImlubGluZSI6ZmFsc2UsInNvdXJjZSI6InZpZXdvZiBUX21pbiA9IElucHV0cy5yYW5nZShcbiAgWy01LCAyMF0sIFxuICB7dmFsdWU6IDEwLCBzdGVwOiAwLjIsIGxhYmVsOiBcIlRtaW46XCJ9XG4pXG52aWV3b2YgVF9tYXggPSBJbnB1dHMucmFuZ2UoXG4gIFszMCwgNTBdLCBcbiAge3ZhbHVlOiAzNSwgc3RlcDogMC4yLCBsYWJlbDogXCJUbWF4OlwifVxuKVxuXG52aWV3b2Ygcl9tYXggPSBJbnB1dHMucmFuZ2UoXG4gIFswLCAxLjJdLCBcbiAge3ZhbHVlOiAxLCBzdGVwOiAwLjEsIGxhYmVsOiBcInJtYXg6XCJ9XG4pXG5cbnZpZXdvZiBhbHBoYSA9IElucHV0cy5yYW5nZShcbiAgWzAsIDFdLCBcbiAge3ZhbHVlOiAwLjgsIHN0ZXA6IDAuMDIsIGxhYmVsOiBcImFscGhhOlwifVxuKVxuXG52aWV3b2YgYmV0YSA9IElucHV0cy5yYW5nZShcbiAgWzAsIDFdLCBcbiAge3ZhbHVlOiAwLjMsIHN0ZXA6IDAuMDIsIGxhYmVsOiBcImJldGE6XCJ9XG4pXG4ifSx7Im1ldGhvZE5hbWUiOiJpbnRlcnByZXQiLCJjZWxsTmFtZSI6Im9qcy1jZWxsLTIiLCJpbmxpbmUiOmZhbHNlLCJzb3VyY2UiOiJcbmZ1bmN0aW9uIGluY3JlbWVudGFsQXJyYXkoc3RhcnQsIGVuZCwgc3RlcCkge1xuICAgIHZhciBhcnIgPSBbXTtcbiAgICAvLyBjb252ZXJ0IGNvdW50IHRvIGFuIGludGVnZXIgdG8gYXZvaWQgcm91bmRpbmcgZXJyb3JzXG4gICAgdmFyIGNvdW50ID0gKygoZW5kIC0gc3RhcnQpIC8gc3RlcCkudG9GaXhlZCgpO1xuICAgIGZvciAodmFyIGogPSAwOyBqIDw9IGNvdW50OyBqKyspIHtcbiAgICAgICAgdmFyIGkgPSBzdGFydCArIGogKiBzdGVwO1xuICAgICAgICBhcnIucHVzaChpKTtcbiAgICB9XG4gICAgcmV0dXJuIGFycjtcbn1cblxuZnVuY3Rpb24gZmxleFRQQyh4LCBUX21pbiwgVF9tYXgsIHJfbWF4LCBhbHBoYSwgYmV0YSkge1xuICBpZiAoeCA8IFRfbWluKSB7XG4gIHJldHVybiAwLjBcbiAgfVxuICBpZiAoeCA+IFRfbWF4KSB7XG4gIHJldHVybiAwLjBcbiAgfVxuICByZXR1cm4gcl9tYXggKiBNYXRoLmV4cCgoYWxwaGEgKiAoMS4wIC0gYWxwaGEpIC8gYmV0YSoqMikgKiAoYWxwaGEgKiAgICBNYXRoLmxvZyggKHggLSBUX21pbikgLyBhbHBoYSkgICsgXG4gICAgICAoMS4wIC0gYWxwaGEpICogTWF0aC5sb2coIChUX21heCAtIHgpIC8gKDEuMCAtIGFscGhhKSkgLVxuICAgICAgTWF0aC5sb2coVF9tYXggLSBUX21pbikpKVxufVxuXG54dmFscyA9IGluY3JlbWVudGFsQXJyYXkoLTUsIDUwLCAwLjEpXG55dmFscyA9IHh2YWxzLm1hcCgoeCkgPT4gZmxleFRQQyh4LCBUX21pbiwgVF9tYXgsIHJfbWF4LCBhbHBoYSwgYmV0YSkpXG56aXAgPSAoYSwgYikgPT4gYS5tYXAoKGssIGkpID0+IFtrLCBiW2ldXSk7XG5kYXRhID0gemlwKHh2YWxzLCB5dmFscylcblxuUGxvdC5wbG90KHtcbiAgd2lkdGg6IDYwMCxcbiAgaGVpZ2h0OiA0MDAsXG4gIHk6IHsgZG9tYWluOiBbLTAuMDEsIDEuMjVdIH0sXG4gIG1hcmtzOiBbXG4gICAgUGxvdC5saW5lKFxuICAgICAgZGF0YSxcbiAgICAgIHtcbiAgICAgICAgc3Ryb2tlV2lkdGg6IDMsXG4gICAgICAgIHN0cm9rZTogXCJzdGVlbGJsdWVcIixcbiAgICAgICAgZm9udFNpemU6IDE0XG4gICAgICB9XG4gICAgKSxcbiAgICBQbG90LnJ1bGVYKFswXSksXG4gICAgUGxvdC5ydWxlWShbMF0pLFxuICAgIFBsb3QuYXhpc1goe2xhYmVsOiBcIlRlbXBlcmF0dXJlIFvCsENdXCIsIGZvbnRTaXplOiAxNCwgbWFyZ2luQm90dG9tOiA0MH0pLFxuICAgIFBsb3QuYXhpc1koe2xhYmVsOiBcInRyYWl0IHBlcmZvcm1hbmNlXCIsIGZvbnRTaXplOiAxNCwgeDogMCB9KVxuICBdXG59KVxuIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdUX21pbicpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdUX21heCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdyX21heCcpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdhbHBoYScpIn0seyJtZXRob2ROYW1lIjoiaW50ZXJwcmV0UXVpZXQiLCJzb3VyY2UiOiJzaGlueUlucHV0KCdiZXRhJykifV19
</script>
<script type="module">
if (window.location.protocol === "file:") { alert("The OJS runtime does not work with file:// URLs. Please use a web server to view this document."); }
window._ojs.paths.runtimeToDoc = "../..";
window._ojs.paths.runtimeToRoot = "../..";
window._ojs.paths.docToRoot = "";
window._ojs.selfContained = false;
window._ojs.runtime.interpretFromScriptTags();
</script>
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>